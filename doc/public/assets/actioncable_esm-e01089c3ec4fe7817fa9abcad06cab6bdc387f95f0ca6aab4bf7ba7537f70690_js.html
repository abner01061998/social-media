<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>actioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    
<div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
    <li><a href="../../Gemfile.html">Gemfile</a>
    <li><a href="../../Gemfile_lock.html">Gemfile.lock</a>
    <li><a href="../../README_md.html">README</a>
    <li><a href="../../Rakefile.html">Rakefile</a>
    <li><a href="../../app/assets/config/manifest_js.html">manifest.js</a>
    <li><a href="../../app/assets/stylesheets/application_scss.html">application.scss</a>
    <li><a href="../../app/assets/stylesheets/custom_css.html">custom.css</a>
    <li><a href="../../app/javascript/application_js.html">application.js</a>
    <li><a href="../../app/javascript/controllers/application_js.html">application.js</a>
    <li><a href="../../app/javascript/controllers/hello_controller_js.html">hello_controller.js</a>
    <li><a href="../../app/javascript/controllers/index_js.html">index.js</a>
    <li><a href="../../bin/bundle_cmd.html">bundle.cmd</a>
    <li><a href="../../config_ru.html">config.ru</a>
    <li><a href="../../config/credentials_yml_enc.html">credentials.yml.enc</a>
    <li><a href="../../config/master_key.html">master.key</a>
    <li><a href="../../db/production_sqlite3.html">production.sqlite3</a>
    <li><a href="../../log/development_log.html">development.log</a>
    <li><a href="../../log/production_log.html">production.log</a>
    <li><a href="../../public/404_html.html">404.html</a>
    <li><a href="../../public/422_html.html">422.html</a>
    <li><a href="../../public/500_html.html">500.html</a>
    <li><a href="../../public/apple-touch-icon-precomposed_png.html">apple-touch-icon-precomposed.png</a>
    <li><a href="../../public/apple-touch-icon_png.html">apple-touch-icon.png</a>
    <li><a href="../../public/assets/actioncable-5433453f9b6619a9de91aaab2d7fc7ff183e5260c0107cbc9a1aa0c838d9a74e_js.html">actioncable-5433453f9b6619a9de91aaab2d7fc7ff183e5260c0107cbc9a1aa0c838d9a74e.js</a>
    <li><a href="../../public/assets/actioncable_esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690_js.html">actioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js</a>
    <li><a href="../../public/assets/actiontext-28c61f5197c204db043317a8f8826a87ab31495b741f854d307ca36122deefce_js.html">actiontext-28c61f5197c204db043317a8f8826a87ab31495b741f854d307ca36122deefce.js</a>
    <li><a href="../../public/assets/activestorage-3ab61e47dd4ee2d79db525ade1dca2ede0ea2b7371fe587e408ee37b7ade265d_js.html">activestorage-3ab61e47dd4ee2d79db525ade1dca2ede0ea2b7371fe587e408ee37b7ade265d.js</a>
    <li><a href="../../public/assets/activestorage_esm-01f58a45d77495cdfbdfcc872902a430426c4391634ec9c3da5f69fbf8418492_js.html">activestorage.esm-01f58a45d77495cdfbdfcc872902a430426c4391634ec9c3da5f69fbf8418492.js</a>
    <li><a href="../../public/assets/application-32d4b75e744a8a8e755359e6017482014dee13b0c2f0861d571e55531d39a79d_css.html">application-32d4b75e744a8a8e755359e6017482014dee13b0c2f0861d571e55531d39a79d.css</a>
    <li><a href="../../public/assets/application-3e73deab22b3cbf32eae8a405cc3f28cfe3ab81a37fecca6ddbbe46c75af5b0e_css.html">application-3e73deab22b3cbf32eae8a405cc3f28cfe3ab81a37fecca6ddbbe46c75af5b0e.css</a>
    <li><a href="../../public/assets/application-4668a63fc7682ef88af586a54008d0c129dc516b342577afb0de28e081796840_css.html">application-4668a63fc7682ef88af586a54008d0c129dc516b342577afb0de28e081796840.css</a>
    <li><a href="../../public/assets/application-7ac6076e7d9cab030797f1bfe2cf764861a60dc215f623dde8cb933ae0bf10dc_js.html">application-7ac6076e7d9cab030797f1bfe2cf764861a60dc215f623dde8cb933ae0bf10dc.js</a>
    <li><a href="../../public/assets/application-a44e181b486d978d63932a4db09338ae502d90e10c0bdd395aa839123aeea2ec_css.html">application-a44e181b486d978d63932a4db09338ae502d90e10c0bdd395aa839123aeea2ec.css</a>
    <li><a href="../../public/assets/application-ac2e01aa9a494aeeba9e1c95a30a26e3dd5b5ac439d25b67aa38832295e26c3d_css.html">application-ac2e01aa9a494aeeba9e1c95a30a26e3dd5b5ac439d25b67aa38832295e26c3d.css</a>
    <li><a href="../../public/assets/application-dc2d2d6cd177033c4b2946f0fdc563dc111e103bced6042c2b7649f314306f58_css.html">application-dc2d2d6cd177033c4b2946f0fdc563dc111e103bced6042c2b7649f314306f58.css</a>
    <li><a href="../../public/assets/bootstrap_min-20a034247d4d545a7a2d49d62ee00c40f53f825562ed9d6c9af1ad42383e67f6_js.html">bootstrap.min-20a034247d4d545a7a2d49d62ee00c40f53f825562ed9d6c9af1ad42383e67f6.js</a>
    <li><a href="../../public/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e_js.html">application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js</a>
    <li><a href="../../public/assets/controllers/hello_controller-549135e8e7c683a538c3d6d517339ba470fcfb79d62f738a0a089ba41851a554_js.html">hello_controller-549135e8e7c683a538c3d6d517339ba470fcfb79d62f738a0a089ba41851a554.js</a>
    <li><a href="../../public/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806_js.html">index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js</a>
    <li><a href="../../public/assets/custom-77945ec94022f825cfe7d6166e97092d87ca4f55627c8062b56cfb9f1a35f205_css.html">custom-77945ec94022f825cfe7d6166e97092d87ca4f55627c8062b56cfb9f1a35f205.css</a>
    <li><a href="../../public/assets/custom-7eba9728e51d5c26d8d1cf50340b4b3ad9251d8a5f0142ef57211377bd50fcfc_css.html">custom-7eba9728e51d5c26d8d1cf50340b4b3ad9251d8a5f0142ef57211377bd50fcfc.css</a>
    <li><a href="../../public/assets/custom-de99a0f588d04e64f8aa62da913f7225b090eb13fbfe74a7315f1715cdefec1d_css.html">custom-de99a0f588d04e64f8aa62da913f7225b090eb13fbfe74a7315f1715cdefec1d.css</a>
    <li><a href="../../public/assets/custom-e30bda1bcb7eaa86b4f7970e250dadbfd4aa17f32943e7e25ef353bd822fd884_css.html">custom-e30bda1bcb7eaa86b4f7970e250dadbfd4aa17f32943e7e25ef353bd822fd884.css</a>
    <li><a href="../../public/assets/es-module-shims-16719834c9bbcdd75f1f99da713bd0c89de488be94d4c5df594511f39cffe7c1_js.html">es-module-shims-16719834c9bbcdd75f1f99da713bd0c89de488be94d4c5df594511f39cffe7c1.js</a>
    <li><a href="../../public/assets/es-module-shims_js-32db422c5db541b7129a2ce936aed905edc2cd481748f8d67ffe84e28313158a_map.html">es-module-shims.js-32db422c5db541b7129a2ce936aed905edc2cd481748f8d67ffe84e28313158a.map</a>
    <li><a href="../../public/assets/es-module-shims_min-d89e73202ec09dede55fb74115af9c5f9f2bb965433de1c2446e1faa6dac2470_js.html">es-module-shims.min-d89e73202ec09dede55fb74115af9c5f9f2bb965433de1c2446e1faa6dac2470.js</a>
    <li><a href="../../public/assets/manifest-b84bfa46a33d7f0dc4d2e7b8889486c9a957a5e40713d58f54be71b66954a1ff_js.html">manifest-b84bfa46a33d7f0dc4d2e7b8889486c9a957a5e40713d58f54be71b66954a1ff.js</a>
    <li><a href="../../public/assets/popper-15792033e209365e7b75c100dae2b69cba31b26b18b289383d22eb67639aad75_js.html">popper-15792033e209365e7b75c100dae2b69cba31b26b18b289383d22eb67639aad75.js</a>
    <li><a href="../../public/assets/stimulus-2e76632599c700da6e187ce7b15eea7c0eace0e09f25d19e55e3b1f7c515397c_js.html">stimulus-2e76632599c700da6e187ce7b15eea7c0eace0e09f25d19e55e3b1f7c515397c.js</a>
    <li><a href="../../public/assets/stimulus-autoloader-c584942b568ba74879da31c7c3d51366737bacaf6fbae659383c0a5653685693_js.html">stimulus-autoloader-c584942b568ba74879da31c7c3d51366737bacaf6fbae659383c0a5653685693.js</a>
    <li><a href="../../public/assets/stimulus-importmap-autoloader-db2076c783bf2dbee1226e2add52fef290b5d31b5bcd1edd999ac8a6dd31c44a_js.html">stimulus-importmap-autoloader-db2076c783bf2dbee1226e2add52fef290b5d31b5bcd1edd999ac8a6dd31c44a.js</a>
    <li><a href="../../public/assets/stimulus-loading-1fc59770fb1654500044afd3f5f6d7d00800e5be36746d55b94a2963a7a228aa_js.html">stimulus-loading-1fc59770fb1654500044afd3f5f6d7d00800e5be36746d55b94a2963a7a228aa.js</a>
    <li><a href="../../public/assets/stimulus_min-b8a9738499c7a8362910cd545375417370d72a9776fb4e766df7671484e2beb7_js.html">stimulus.min-b8a9738499c7a8362910cd545375417370d72a9776fb4e766df7671484e2beb7.js</a>
    <li><a href="../../public/assets/stimulus_min_js-8d1a076cbda7e5ed0992e208db54c62a8de8b1f9694828e1a601fbccd9291649_map.html">stimulus.min.js-8d1a076cbda7e5ed0992e208db54c62a8de8b1f9694828e1a601fbccd9291649.map</a>
    <li><a href="../../public/assets/trix-1563ff9c10f74e143b3ded40a8458497eaf2f87a648a5cbbfebdb7dec3447a5e_js.html">trix-1563ff9c10f74e143b3ded40a8458497eaf2f87a648a5cbbfebdb7dec3447a5e.js</a>
    <li><a href="../../public/assets/trix-fe178d6f8c056d8e63aecb6557bc65676897f43e4aee3e68584437841a99fc23_css.html">trix-fe178d6f8c056d8e63aecb6557bc65676897f43e4aee3e68584437841a99fc23.css</a>
    <li><a href="../../public/assets/turbo-118a59d5569d8a8b343ee3cd7f2c39b6b5fa5f236368b332e2db7bdad59d1ca9_js.html">turbo-118a59d5569d8a8b343ee3cd7f2c39b6b5fa5f236368b332e2db7bdad59d1ca9.js</a>
    <li><a href="../../public/assets/turbo_min-3b666ce240bde65e66d795553a062443a3b139e38646fe31740d354a41653fcc_js.html">turbo.min-3b666ce240bde65e66d795553a062443a3b139e38646fe31740d354a41653fcc.js</a>
    <li><a href="../../public/assets/turbo_min_js-c3141c67d707e81f67affd6a77f1657e298d5cb8aac6628e892669905b33786e_map.html">turbo.min.js-c3141c67d707e81f67affd6a77f1657e298d5cb8aac6628e892669905b33786e.map</a>
    <li><a href="../../public/favicon_ico.html">favicon.ico</a>
    <li><a href="../../public/robots_txt.html">robots</a>
    <li><a href="../../tmp/development_secret_txt.html">development_secret</a>
    <li><a href="../../tmp/pids/server_pid.html">server.pid</a>
    <li><a href="../../tmp/restart_txt.html">restart</a>
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page public/assets/actioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js">

<p>var adapters = {</p>

<pre>logger: self.console,
WebSocket: self.WebSocket</pre>

<p>};</p>

<p>var logger = {</p>

<pre>log(...messages) {
  if (this.enabled) {
    messages.push(Date.now());
    adapters.logger.log(&quot;[ActionCable]&quot;, ...messages);
  }
}</pre>

<p>};</p>

<p>const now = () =&gt; (new Date).getTime();</p>

<p>const secondsSince = time =&gt; (now() - time) / 1e3;</p>

<p>class ConnectionMonitor {</p>

<pre>constructor(connection) {
  this.visibilityDidChange = this.visibilityDidChange.bind(this);
  this.connection = connection;
  this.reconnectAttempts = 0;
}
start() {
  if (!this.isRunning()) {
    this.startedAt = now();
    delete this.stoppedAt;
    this.startPolling();
    addEventListener(&quot;visibilitychange&quot;, this.visibilityDidChange);
    logger.log(`ConnectionMonitor started. stale threshold = ${this.constructor.staleThreshold} s`);
  }
}
stop() {
  if (this.isRunning()) {
    this.stoppedAt = now();
    this.stopPolling();
    removeEventListener(&quot;visibilitychange&quot;, this.visibilityDidChange);
    logger.log(&quot;ConnectionMonitor stopped&quot;);
  }
}
isRunning() {
  return this.startedAt &amp;&amp; !this.stoppedAt;
}
recordPing() {
  this.pingedAt = now();
}
recordConnect() {
  this.reconnectAttempts = 0;
  this.recordPing();
  delete this.disconnectedAt;
  logger.log(&quot;ConnectionMonitor recorded connect&quot;);
}
recordDisconnect() {
  this.disconnectedAt = now();
  logger.log(&quot;ConnectionMonitor recorded disconnect&quot;);
}
startPolling() {
  this.stopPolling();
  this.poll();
}
stopPolling() {
  clearTimeout(this.pollTimeout);
}
poll() {
  this.pollTimeout = setTimeout((() =&gt; {
    this.reconnectIfStale();
    this.poll();
  }), this.getPollInterval());
}
getPollInterval() {
  const {staleThreshold: staleThreshold, reconnectionBackoffRate: reconnectionBackoffRate} = this.constructor;
  const backoff = Math.pow(1 + reconnectionBackoffRate, Math.min(this.reconnectAttempts, 10));
  const jitterMax = this.reconnectAttempts === 0 ? 1 : reconnectionBackoffRate;
  const jitter = jitterMax * Math.random();
  return staleThreshold * 1e3 * backoff * (1 + jitter);
}
reconnectIfStale() {
  if (this.connectionIsStale()) {
    logger.log(`ConnectionMonitor detected stale connection. reconnectAttempts = ${this.reconnectAttempts}, time stale = ${secondsSince(this.refreshedAt)} s, stale threshold = ${this.constructor.staleThreshold} s`);
    this.reconnectAttempts++;
    if (this.disconnectedRecently()) {
      logger.log(`ConnectionMonitor skipping reopening recent disconnect. time disconnected = ${secondsSince(this.disconnectedAt)} s`);
    } else {
      logger.log(&quot;ConnectionMonitor reopening&quot;);
      this.connection.reopen();
    }
  }
}
get refreshedAt() {
  return this.pingedAt ? this.pingedAt : this.startedAt;
}
connectionIsStale() {
  return secondsSince(this.refreshedAt) &gt; this.constructor.staleThreshold;
}
disconnectedRecently() {
  return this.disconnectedAt &amp;&amp; secondsSince(this.disconnectedAt) &lt; this.constructor.staleThreshold;
}
visibilityDidChange() {
  if (document.visibilityState === &quot;visible&quot;) {
    setTimeout((() =&gt; {
      if (this.connectionIsStale() || !this.connection.isOpen()) {
        logger.log(`ConnectionMonitor reopening stale connection on visibilitychange. visibilityState = ${document.visibilityState}`);
        this.connection.reopen();
      }
    }), 200);
  }
}</pre>

<p>}</p>

<p>ConnectionMonitor.staleThreshold = 6;</p>

<p>ConnectionMonitor.reconnectionBackoffRate = .15;</p>

<p>var INTERNAL = {</p>

<pre>message_types: {
  welcome: &quot;welcome&quot;,
  disconnect: &quot;disconnect&quot;,
  ping: &quot;ping&quot;,
  confirmation: &quot;confirm_subscription&quot;,
  rejection: &quot;reject_subscription&quot;
},
disconnect_reasons: {
  unauthorized: &quot;unauthorized&quot;,
  invalid_request: &quot;invalid_request&quot;,
  server_restart: &quot;server_restart&quot;
},
default_mount_path: &quot;/cable&quot;,
protocols: [ &quot;actioncable-v1-json&quot;, &quot;actioncable-unsupported&quot; ]</pre>

<p>};</p>

<p>const {message_types: message_types, protocols: protocols} = INTERNAL;</p>

<p>const supportedProtocols = protocols.slice(0, protocols.length - 1);</p>

<p>const indexOf = [].indexOf;</p>

<p>class Connection {</p>

<pre>constructor(consumer) {
  this.open = this.open.bind(this);
  this.consumer = consumer;
  this.subscriptions = this.consumer.subscriptions;
  this.monitor = new ConnectionMonitor(this);
  this.disconnected = true;
}
send(data) {
  if (this.isOpen()) {
    this.webSocket.send(JSON.stringify(data));
    return true;
  } else {
    return false;
  }
}
open() {
  if (this.isActive()) {
    logger.log(`Attempted to open WebSocket, but existing socket is ${this.getState()}`);
    return false;
  } else {
    logger.log(`Opening WebSocket, current state is ${this.getState()}, subprotocols: ${protocols}`);
    if (this.webSocket) {
      this.uninstallEventHandlers();
    }
    this.webSocket = new adapters.WebSocket(this.consumer.url, protocols);
    this.installEventHandlers();
    this.monitor.start();
    return true;
  }
}
close({allowReconnect: allowReconnect} = {
  allowReconnect: true
}) {
  if (!allowReconnect) {
    this.monitor.stop();
  }
  if (this.isOpen()) {
    return this.webSocket.close();
  }
}
reopen() {
  logger.log(`Reopening WebSocket, current state is ${this.getState()}`);
  if (this.isActive()) {
    try {
      return this.close();
    } catch (error) {
      logger.log(&quot;Failed to reopen WebSocket&quot;, error);
    } finally {
      logger.log(`Reopening WebSocket in ${this.constructor.reopenDelay}ms`);
      setTimeout(this.open, this.constructor.reopenDelay);
    }
  } else {
    return this.open();
  }
}
getProtocol() {
  if (this.webSocket) {
    return this.webSocket.protocol;
  }
}
isOpen() {
  return this.isState(&quot;open&quot;);
}
isActive() {
  return this.isState(&quot;open&quot;, &quot;connecting&quot;);
}
isProtocolSupported() {
  return indexOf.call(supportedProtocols, this.getProtocol()) &gt;= 0;
}
isState(...states) {
  return indexOf.call(states, this.getState()) &gt;= 0;
}
getState() {
  if (this.webSocket) {
    for (let state in adapters.WebSocket) {
      if (adapters.WebSocket[state] === this.webSocket.readyState) {
        return state.toLowerCase();
      }
    }
  }
  return null;
}
installEventHandlers() {
  for (let eventName in this.events) {
    const handler = this.events[eventName].bind(this);
    this.webSocket[`on${eventName}`] = handler;
  }
}
uninstallEventHandlers() {
  for (let eventName in this.events) {
    this.webSocket[`on${eventName}`] = function() {};
  }
}</pre>

<p>}</p>

<p>Connection.reopenDelay = 500;</p>

<p>Connection.prototype.events = {</p>

<pre>message(event) {
  if (!this.isProtocolSupported()) {
    return;
  }
  const {identifier: identifier, message: message, reason: reason, reconnect: reconnect, type: type} = JSON.parse(event.data);
  switch (type) {
   case message_types.welcome:
    this.monitor.recordConnect();
    return this.subscriptions.reload();

   case message_types.disconnect:
    logger.log(`Disconnecting. Reason: ${reason}`);
    return this.close({
      allowReconnect: reconnect
    });

   case message_types.ping:
    return this.monitor.recordPing();

   case message_types.confirmation:
    this.subscriptions.confirmSubscription(identifier);
    return this.subscriptions.notify(identifier, &quot;connected&quot;);

   case message_types.rejection:
    return this.subscriptions.reject(identifier);

   default:
    return this.subscriptions.notify(identifier, &quot;received&quot;, message);
  }
},
open() {
  logger.log(`WebSocket onopen event, using &#39;${this.getProtocol()}&#39; subprotocol`);
  this.disconnected = false;
  if (!this.isProtocolSupported()) {
    logger.log(&quot;Protocol is unsupported. Stopping monitor and disconnecting.&quot;);
    return this.close({
      allowReconnect: false
    });
  }
},
close(event) {
  logger.log(&quot;WebSocket onclose event&quot;);
  if (this.disconnected) {
    return;
  }
  this.disconnected = true;
  this.monitor.recordDisconnect();
  return this.subscriptions.notifyAll(&quot;disconnected&quot;, {
    willAttemptReconnect: this.monitor.isRunning()
  });
},
error() {
  logger.log(&quot;WebSocket onerror event&quot;);
}</pre>

<p>};</p>

<p>const extend = function(object, properties) {</p>

<pre>if (properties != null) {
  for (let key in properties) {
    const value = properties[key];
    object[key] = value;
  }
}
return object;</pre>

<p>};</p>

<p>class Subscription {</p>

<pre class="ruby"><span class="ruby-identifier">constructor</span>(<span class="ruby-identifier">consumer</span>, <span class="ruby-identifier">params</span> = {}, <span class="ruby-identifier">mixin</span>) {
  <span class="ruby-identifier">this</span>.<span class="ruby-identifier">consumer</span> = <span class="ruby-identifier">consumer</span>;
  <span class="ruby-identifier">this</span>.<span class="ruby-identifier">identifier</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">stringify</span>(<span class="ruby-identifier">params</span>);
  <span class="ruby-identifier">extend</span>(<span class="ruby-identifier">this</span>, <span class="ruby-identifier">mixin</span>);
}
<span class="ruby-identifier">perform</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">data</span> = {}) {
  <span class="ruby-identifier">data</span>.<span class="ruby-identifier">action</span> = <span class="ruby-identifier">action</span>;
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">this</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">data</span>);
}
<span class="ruby-identifier">send</span>(<span class="ruby-identifier">data</span>) {
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">this</span>.<span class="ruby-identifier">consumer</span>.<span class="ruby-identifier">send</span>({
    <span class="ruby-value">command:</span> <span class="ruby-string">&quot;message&quot;</span>,
    <span class="ruby-value">identifier:</span> <span class="ruby-identifier">this</span>.<span class="ruby-identifier">identifier</span>,
    <span class="ruby-value">data:</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">stringify</span>(<span class="ruby-identifier">data</span>)
  });
}
<span class="ruby-identifier">unsubscribe</span>() {
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">this</span>.<span class="ruby-identifier">consumer</span>.<span class="ruby-identifier">subscriptions</span>.<span class="ruby-identifier">remove</span>(<span class="ruby-identifier">this</span>);
}
</pre>

<p>}</p>

<p>class SubscriptionGuarantor {</p>

<pre>constructor(subscriptions) {
  this.subscriptions = subscriptions;
  this.pendingSubscriptions = [];
}
guarantee(subscription) {
  if (this.pendingSubscriptions.indexOf(subscription) == -1) {
    logger.log(`SubscriptionGuarantor guaranteeing ${subscription.identifier}`);
    this.pendingSubscriptions.push(subscription);
  } else {
    logger.log(`SubscriptionGuarantor already guaranteeing ${subscription.identifier}`);
  }
  this.startGuaranteeing();
}
forget(subscription) {
  logger.log(`SubscriptionGuarantor forgetting ${subscription.identifier}`);
  this.pendingSubscriptions = this.pendingSubscriptions.filter((s =&gt; s !== subscription));
}
startGuaranteeing() {
  this.stopGuaranteeing();
  this.retrySubscribing();
}
stopGuaranteeing() {
  clearTimeout(this.retryTimeout);
}
retrySubscribing() {
  this.retryTimeout = setTimeout((() =&gt; {
    if (this.subscriptions &amp;&amp; typeof this.subscriptions.subscribe === &quot;function&quot;) {
      this.pendingSubscriptions.map((subscription =&gt; {
        logger.log(`SubscriptionGuarantor resubscribing ${subscription.identifier}`);
        this.subscriptions.subscribe(subscription);
      }));
    }
  }), 500);
}</pre>

<p>}</p>

<p>class Subscriptions {</p>

<pre>constructor(consumer) {
  this.consumer = consumer;
  this.guarantor = new SubscriptionGuarantor(this);
  this.subscriptions = [];
}
create(channelName, mixin) {
  const channel = channelName;
  const params = typeof channel === &quot;object&quot; ? channel : {
    channel: channel
  };
  const subscription = new Subscription(this.consumer, params, mixin);
  return this.add(subscription);
}
add(subscription) {
  this.subscriptions.push(subscription);
  this.consumer.ensureActiveConnection();
  this.notify(subscription, &quot;initialized&quot;);
  this.subscribe(subscription);
  return subscription;
}
remove(subscription) {
  this.forget(subscription);
  if (!this.findAll(subscription.identifier).length) {
    this.sendCommand(subscription, &quot;unsubscribe&quot;);
  }
  return subscription;
}
reject(identifier) {
  return this.findAll(identifier).map((subscription =&gt; {
    this.forget(subscription);
    this.notify(subscription, &quot;rejected&quot;);
    return subscription;
  }));
}
forget(subscription) {
  this.guarantor.forget(subscription);
  this.subscriptions = this.subscriptions.filter((s =&gt; s !== subscription));
  return subscription;
}
findAll(identifier) {
  return this.subscriptions.filter((s =&gt; s.identifier === identifier));
}
reload() {
  return this.subscriptions.map((subscription =&gt; this.subscribe(subscription)));
}
notifyAll(callbackName, ...args) {
  return this.subscriptions.map((subscription =&gt; this.notify(subscription, callbackName, ...args)));
}
notify(subscription, callbackName, ...args) {
  let subscriptions;
  if (typeof subscription === &quot;string&quot;) {
    subscriptions = this.findAll(subscription);
  } else {
    subscriptions = [ subscription ];
  }
  return subscriptions.map((subscription =&gt; typeof subscription[callbackName] === &quot;function&quot; ? subscription[callbackName](...args) : undefined));
}
subscribe(subscription) {
  if (this.sendCommand(subscription, &quot;subscribe&quot;)) {
    this.guarantor.guarantee(subscription);
  }
}
confirmSubscription(identifier) {
  logger.log(`Subscription confirmed ${identifier}`);
  this.findAll(identifier).map((subscription =&gt; this.guarantor.forget(subscription)));
}
sendCommand(subscription, command) {
  const {identifier: identifier} = subscription;
  return this.consumer.send({
    command: command,
    identifier: identifier
  });
}</pre>

<p>}</p>

<p>class Consumer {</p>

<pre>constructor(url) {
  this._url = url;
  this.subscriptions = new Subscriptions(this);
  this.connection = new Connection(this);
}
get url() {
  return createWebSocketURL(this._url);
}
send(data) {
  return this.connection.send(data);
}
connect() {
  return this.connection.open();
}
disconnect() {
  return this.connection.close({
    allowReconnect: false
  });
}
ensureActiveConnection() {
  if (!this.connection.isActive()) {
    return this.connection.open();
  }
}</pre>

<p>}</p>

<p>function createWebSocketURL(url) {</p>

<pre>if (typeof url === &quot;function&quot;) {
  url = url();
}
if (url &amp;&amp; !/^wss?:/i.test(url)) {
  const a = document.createElement(&quot;a&quot;);
  a.href = url;
  a.href = a.href;
  a.protocol = a.protocol.replace(&quot;http&quot;, &quot;ws&quot;);
  return a.href;
} else {
  return url;
}</pre>

<p>}</p>

<p>function createConsumer(url = getConfig(“url”) || INTERNAL.default_mount_path) {</p>

<pre class="ruby"><span class="ruby-keyword">return</span> <span class="ruby-identifier">new</span> <span class="ruby-constant">Consumer</span>(<span class="ruby-identifier">url</span>);
</pre>

<p>}</p>

<p>function getConfig(name) {</p>

<pre>const element = document.head.querySelector(`meta[name=&#39;action-cable-${name}&#39;]`);
if (element) {
  return element.getAttribute(&quot;content&quot;);
}</pre>

<p>}</p>

<p>export { Connection, ConnectionMonitor, Consumer, INTERNAL, Subscription, SubscriptionGuarantor, Subscriptions, adapters, createConsumer, createWebSocketURL, getConfig, logger };</p>

</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.4.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

